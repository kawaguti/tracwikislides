 <html>                                                                  
 <head>                                                                  
 <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

 <!-- Please set your suitable jQuery 1.3.1 path -->
 <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.1/jquery.min.js"></script>

 <!-- TracWikiSlides -->
 <script type="text/javascript">

 //--------------------------------------------------------------
 // settings for this slide
 //   wiki_url: source wiki document path
 //   attachment_url: attachment image file path
 //--------------------------------------------------------------
 var settings = {
     "wiki_url": "",
     "text_url": "",
     "attachment_url": ""
 }

 //--------------------------------------------------------------
 // presantation: Presentation Object
 //--------------------------------------------------------------
 var presentation = function () {
     this.pages = [];
     this.pages_size = 0;
     this.pages_pointer = 0;

     this.get_first_page = function () {
	 this.pages_pointer = 0;
	 return this.get_page(this.pages_pointer);
     }
     
     this.get_prev_page = function () {
	 if ( this.pages_pointer > 0 ) {
	     this.pages_pointer = this.pages_pointer - 1;
	 }
	 return this.get_page(this.pages_pointer);
     }
     
     this.get_next_page = function () {
	 if ( this.pages_pointer < this.pages_size - 1 ) {
	     this.pages_pointer = this.pages_pointer + 1;
	 }
	 return this.get_page(this.pages_pointer);
     }
     
     this.get_last_page = function () {
	 this.pages_pointer = this.pages_size - 1;
	 return this.get_page(this.pages_pointer);
     }
     
     this.get_current_page = function () {
	 return this.get_page(this.pages_pointer);
     }

     this.get_page = function (i) {
	 return this.pages[i];
     }
     
     this.dump = function () {
	 var r = [];
	 for ( var i = 0; i < this.pages_size; i++ ) {
	     r[i] = i + ":" + this.pages[i].join("|");
	 }
	 return r.join("\n");
     }
     
     this.page_buffer = [];
     this.page_buffer_size = 0;
     this.page_buffer_type = "";
     this.add_page = function (page_type, page) {
	 switch (page_type) {
 	 case "header": //Header Style Page
 	     this.pages[this.pages_size] = [page_type, page];
	     this.pages_size = this.pages_size + 1;
	     break;
 	 case "normal": //Standard Style Page
 	     this.pages[this.pages_size] = [page_type, page];
	     this.pages_size = this.pages_size + 1;
	     break;
	 case "quoted": //Quoted-String Style Page
 	     this.pages[this.pages_size] = [page_type, page];
	     this.pages_size = this.pages_size + 1;
	     break;
	 case "picture": //Image Style Page
 	     this.pages[this.pages_size] = [page_type, page];
	     this.pages_size = this.pages_size + 1;
	     break;
	 }
     }

     this.flush_page_buffer = function() {
	 if ( this.page_buffer_size > 0 ) {
	     // Flush (previous) page buffer
	     this.add_page(this.page_buffer_type, this.page_buffer );
	     // Initialize page buffer
	     this.page_buffer_size = 0;
	     this.page_buffer_type = "";
	     this.page_buffer = [];
	 }
     }

     this.add_page_buffer = function(buffer_type, page_line) {
	 if ( this.page_buffer_type != buffer_type ) {
	     this.flush_page_buffer();
	 }
	 this.page_buffer_type = buffer_type;
	 this.page_buffer[this.page_buffer_size] = page_line;
	 this.page_buffer_size = this.page_buffer_size + 1;

     }

     this.add_page_line = function (page_type, line_index, page_line) {
	 //window.console.log(line_index + ":" + page_type + ":" + page_line);
	 
	 switch (page_type) {
	 case "split":
	     this.flush_page_buffer();
	     break;
 	 case "header": //Header Style Page (isolated)
 	 case "picture": //Image Style Page
	     this.flush_page_buffer();
	     this.add_page(page_type, [page_line] );
	     break;
 	 case "normal-title":
	     this.flush_page_buffer();
	     this.add_page_buffer("normal", page_line);
	     break;
 	 case "normal":
	 case "quoted":
	     this.add_page_buffer(page_type, page_line);
	     break;
	 }
     }
 };
 // create presentation object
 var p10n = new presentation();


 //-------------------------------------------------------------- 
 // Navigation_button: UI Operations
 //-------------------------------------------------------------- 
 var navigation_button = function () {
     
     this.first = function() {
	 var p = p10n.get_first_page();
	 this.show_page(p);
     };
     this.prev = function() {
	 var p = p10n.get_prev_page();
	 this.show_page(p);
     };
     this.next = function() {
	 var p = p10n.get_next_page();
	 this.show_page(p);
     };
     this.last = function() {
	 var p = p10n.get_last_page();
	 this.show_page(p);
     };
     this.redraw = function() {
	 var p = p10n.get_current_page();
	 this.show_page(p);
     };
     
     this.show_page = function (p) {
	 var tag = "";
	 switch ( p[0] ) {
	 case "header":
	     var tag = '#p10n-header';
	     $(tag).text(p[1].join("\n"));
	     this.show_this_tag_and_hide_others(tag);
	     break;
	     
	 case "normal":
	     var tag = '#p10n-normal';
	     $(tag).html("<code>" + jQuery.map(p[1], function(s) { return s.replace(/ /g, "&nbsp;"); }).join("<br \>\n") + "</code>");
	     this.show_this_tag_and_hide_others(tag);
	     break;
	     
	 case "quoted":
	     var tag = '#p10n-quoted';
	     $(tag).html(p[1].join("<br />\n"));
	     this.show_this_tag_and_hide_others(tag);
	     break;
	     
	 case "picture":
	     var tag = '#p10n-picture';
	     $(tag).html('<center><img src="' + settings.attachment_url + '/' + p[1] + '" /></center>');
	     this.show_this_tag_and_hide_others(tag);
	     break;

	 case "iframe":
	     var tag = '#p10n-iframe';
	     $(tag).html('<iframe style="width: 100%; height: 100%;" src="' + settings.wiki_url + '/' + p[1] + '" />');
	     this.show_this_tag_and_hide_others(tag);
	     break;
	 }
     };

     this.show_this_tag_and_hide_others = function (tagname) {
	 var tagnames = [
	     '#p10n-header',
	     '#p10n-normal',
	     '#p10n-quoted',
	     '#p10n-picture',
	     '#p10n-iframe'
	 ];
	     
	 $(tagname).show();
	 for ( var t in tagnames ) {
	     if ( tagnames[t] != tagname ) { 
		 $(tagnames[t]).hide();
	     }
	 }
     }
 
     this.menu_toggle = function () {
	 $('#nvgn_btns').toggle(600);
     };

     this.wiki_toggle = function () {
	 //window.console.log("wiki_toggle");
	 if (this.wiki_shown) {
	     this.redraw();
	     this.wiki_shown = false;
	 } else {
	     this.show_page(["iframe", settings.wiki_url]);
	     this.wiki_shown = true;
	 }
     };

 }
 // create navigation button Object
 var nvgn_btn = new navigation_button();
 
 //-------------------------------------------------------------- 
 // show_slides: 
 //-------------------------------------------------------------- 
 // Aquire wiki data, convert to slides, and show them.
 //-------------------------------------------------------------- 
 function show_slides (wikiname) {
     $('#url').blur();
     settings.wiki_url = "../../wiki/" + wikiname;
     settings.text_url = settings.wiki_url + "?format=txt";
     settings.attachment_url = "../../raw-attachment/wiki/" + wikiname;
     p10n = new presentation();

     $.get( settings.text_url, function(data){
	 var data_array = data.split("\n");
 	 jQuery.each(data_array, function(index, s) {

	     //----------------------
	     // inline rules
	     //----------------------
	     // - bold italic
	     s = s.replace(/\'{5}(.*)\'{5}/, "<b><i>$1</i></b>");
	     // - bold
	     s = s.replace(/\'{3}(.*)\'{3}/, "<b>$1</b>");
　	     // - italic
	     s = s.replace(/\'{2}(.*)\'{2}/, "<i>$1</i>");
　	     // - undeline
	     s = s.replace(/_{2}(.*)_{2}/, "<u>$1</u>");
　	     // - strike
	     s = s.replace(/~{2}(.*)~{2}/, "<strike>$1</strike>");
	     // - subscript
	     s = s.replace(/\,{2}(.*)\,{2}/, "<sub>$1</sub>");
	     // - superscript
	     s = s.replace(/\^(.*)\^/, "<sup>$1</sup>");
	     // - inline code
	     s = s.replace(/\{{3}(.*)\}{3}/, "<code>$1</code>");
	     // - inline code2
	     s = s.replace(/\`(.*)\`/, "<Code>$1</code>");

	     //----------------------
	     // block rules
	     //----------------------
 	     // Heading and Subheading
 	     if ( s.match(/^\s*\={1,3}\s*([^\=]+)\s*\={1,3}\s*/) ) {
		 s = RegExp.$1;
 		 p10n.add_page_line("header", index, s);
 		 return;
 	     }
 	     // Horizontal line
	     // => split pages
 	     if ( s.match(/^\s*[\-]{4}/) ) {
 		 p10n.add_page_line("split", index );
 		 return;
 	     }
  	     // List - level 1
  	     if ( s.match(/^\s{0,1}\*/) ) {
  		 p10n.add_page_line("normal-title", index, s);
  		 return;
  	     }
  	     // List - level2+
	     //   locate under previous list
  	     if ( s.match(/^\s+\*/) ) {
  		 p10n.add_page_line("normal", index, s);
  		 return;
  	     }
	     // Discussion Citations
 	     if ( s.match(/^\>/) ) {
		 s = s.replace(/^\>+/, "");
 		 p10n.add_page_line("quoted", index, s);
 		 return;
	     }
	     // Inline Image (macro)
 	     if ( s.match(/^\[\[Image\((.*)\)\]\]/) ) {
 		 p10n.add_page_line("picture", index, RegExp.$1);
 		 return;
	     }
 	 });
	 //window.console.log(p10n.dump());
	 
	 // show first page
	 nvgn_btn.first();
	 
     });
 }

 //-------------------------------------------------------------- 
 // jQuery.ready: 
 //-------------------------------------------------------------- 
 // URL argument => wikiname
 //-------------------------------------------------------------- 
 $(document).ready(function() {
     var url = document.location.href;
     if ( url.match(/\?(.+)$/)) {
	 // URL has an argument
	 var wiki_name = RegExp.$1;
	 $('#url').val(wiki_name);
	 show_slides(wiki_name);
     } else {
	 // URL has no arguments
	 // set focus to url input field
	 $('#url').focus();
     }
 });    

 //-------------------------------------------------------------- 
 // key down event
 //-------------------------------------------------------------- 
 $(document).keydown (function(e) {
     //window.console.log(e.keyCode);
     switch (e.keyCode) {
     case 10: // return key
     case 13: // enter key
     case 32: // space key
     case 34: // page down key
     case 39: // right arrow key
     case 40: // down arrow key
     case 74: // j key
	 nvgn_btn.next();
	 break;
     case 33: // page up key
     case 37: // left arrow key
     case 38: // up arrow key
     case 75: // k key
	 nvgn_btn.prev();
	 break;
     case 77: // m key
	 nvgn_btn.menu_toggle();
	 break;
     case 87: // w key
	 nvgn_btn.wiki_toggle();
	 break;
     }
 });

 </script>                                                               
 </head>                                                                 
 <body style="background-color: black; color: white;">
    <!-- Operation Buttons -->
    <div id="nvgn_btns">
    <div style="width: 900px;">
        <!-- input form -->
        <form onsubmit="show_slides($('#url').val()); return false;">
    wikiname: <input id="url" type="input" value="" size="60" style="background-color:Silver;" />
          <input type="submit" value="Show Slides"/>
 	  <span style="border-left: Solid 1px; padding-left:5px;">
            <input type="button" value="|<" onclick="nvgn_btn.first();" />
            <input type="button" value="<" onclick="nvgn_btn.prev();" />
            <input type="button" value=">" onclick="nvgn_btn.next();" />
            <input type="button" value=">|" onclick="nvgn_btn.last();" />
          </span>
 	  <span style="border-left: Solid 1px; padding-left:5px;">
            <input type="button" value="Hide Menu" onclick="nvgn_btn.menu_toggle();" />
          </span>
        </form>
      </div>
    </div>

    <!-- Presentation Screens by page type -->
    <!-- Header Style Page -->
    <div id="p10n-header" style="display:none; padding-top: 4em; margin-left:2em; font-size: xx-large; border-bottom:Solid 1px Silver;"></div>

    <!-- Standard Style Page -->
    <div id="p10n-normal" style="display:none; padding-top: 1em; font-size: large;"></div>
    
    <!-- Quoted-String Style Page -->
    <div id="p10n-quoted" style="display:none; margin-top:0.2em; padding: 0.5em; border-top: Solid 0.5em Silver; border-bottom: Solid 0.5em Silver; background-color: white; color: Black; font-size: xx-large; width:100%;"></div>

    <!-- Image Style Page -->
    <div id="p10n-picture" style="display:none; padding-top: 1em; font-size: large;"></div>

    <!-- IFrame Page -->
    <div id="p10n-iframe" style="display:none; padding-top: 1em; font-size: large; width:100%; height: 80%;"></div>


 </body>                                                                 
 </html>
